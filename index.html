<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Kaizen Kanban</title>

        <style type="text/css">
            @import url("reset.css");
            @import url("http://downloads.dojotoolkit.org/release-1.7.2/dojo-release-1.7.2/dojo/resources/dojo.css");
            @import url("http://downloads.dojotoolkit.org/release-1.7.2/dojo-release-1.7.2/dojo/resources/dnd.css");
            @import url("dnd.css");
        </style>

        <script data-dojo-config="async: true, packages: [{ name: 'kk', location: '/kk' }]" type="text/javascript" 
            src="http://ajax.googleapis.com/ajax/libs/dojo/1.7.2/dojo/dojo.js"></script>

        <!--<script data-dojo-config="async: true, packages: [{ name: 'kk', location: '/kk' }]" type="text/javascript" 
            src="/dojo-release-1.7.2-src/dojo/dojo.js"></script>-->

        <script type="text/javascript">
            require(
                [ "dojo/data/ItemFileWriteStore", "dojo/dom-class", "dojo/dnd/Source", "dojo/domReady!", "kk/dndCreator" ],
                function(jsonStore, domClass, Source, domReady, dndCreator){

                    var store = new jsonStore({url: "workflow.json"});
                    store.fetch({onBegin: onWorkflowBegin, onItem: gotWorkflow, onError: fetchFailed});

                    var workflowSteps = [];
                    var workflowLength = 0;
                    var storiesLength = 0;

                    function onStoryBegin(size, request){
                        // console.log(size);
                        storiesLength = size-1;
                    }

                    function onWorkflowBegin(size, request){
                        // console.log(size);
                        workflowLength = size-1;
                    }

                    function gotStory(item, request){
                        // console.log(item);
                        workflowSteps[0].insertNodes(false, [item]);

                        if ( item._0 >= storiesLength ) {
                            dndCreator.addListeners();
                        }
                    }

                    function gotWorkflow(item, request){
                        // console.log(item);
                        dndCreator.workflowStepCreator(item);
                        workflowSteps.push(dndCreator.buildCardList(item.id+"Node", []));

                        if ( item._0 >= workflowLength ) {
                            var store = new jsonStore({url: "stories.json"});
                            store.fetch({onBegin: onStoryBegin, onItem: gotStory, onError: fetchFailed});
                        }
                    }

                    function fetchFailed(error, request){
                        console.error(error);
                    }

            });
        </script>
    </head>
    <body>
        <table class="outerContainer">
            <tr id="innerContainer">
            </tr>
        </table>
    </body>
</html>
